<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gestão de Documentos</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">

  <style>
    :root{
      --brand:#6759ff;
      --brand-2:#5547ff;
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#1f2430;
      --muted:#6b7280;
      --border:#e7e9f3;
      --shadow: 0 10px 30px rgba(22, 24, 35, .08);
      --radius:16px;
      --radius-sm:12px;
      --ring: 0 0 0 .25rem rgba(103,89,255,.15);
    }

    *{ box-sizing:border-box; }
    body{
      background:var(--bg);
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    /* App shell */
    .app{
      max-width: 1250px;
      margin: 0 auto;
    }

    /* Top bar */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      margin: 18px 0 16px;
    }

    .searchbox{
      flex:1;
      max-width: 520px;
      position: relative;
    }
    .searchbox input{
      height: 44px;
      padding-left: 42px;
      border-radius: 999px;
      border:1px solid var(--border);
      background:#fff;
      box-shadow: 0 8px 22px rgba(22,24,35,.05);
    }
    .searchbox input:focus{ box-shadow: var(--ring), 0 8px 22px rgba(22,24,35,.05); border-color: rgba(103,89,255,.35); }
    .searchbox i{
      position:absolute;
      left:14px;
      top:50%;
      transform: translateY(-50%);
      color: var(--muted);
      font-size: 18px;
    }

    .viewBtns{
      display:flex;
      gap:8px;
      align-items:center;
    }
    .iconBtn{
      width: 44px;
      height: 44px;
      display:grid;
      place-items:center;
      border-radius: 12px;
      border:1px solid var(--border);
      background:#fff;
      box-shadow: 0 8px 22px rgba(22,24,35,.05);
      color: #1f2430;
      transition: .15s ease;
    }
    .iconBtn:hover{ transform: translateY(-1px); }
    .iconBtn.active{
      border-color: rgba(103,89,255,.45);
      box-shadow: var(--ring), 0 8px 22px rgba(22,24,35,.05);
      color: var(--brand);
    }

    .btn-brand{
      background: var(--brand);
      border-color: var(--brand);
      box-shadow: 0 10px 25px rgba(103,89,255,.25);
    }
    .btn-brand:hover{
      background: var(--brand-2);
      border-color: var(--brand-2);
    }

    /* Filters row */
    .filters{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom: 10px;
    }
    .filters .left, .filters .right{
      display:flex; gap:10px; align-items:center;
    }

    .pillSelect{
      height: 40px;
      border-radius: 999px;
      border:1px solid var(--border);
      background:#fff;
      padding: 0 14px;
      box-shadow: 0 8px 22px rgba(22,24,35,.05);
      min-width: 170px;
    }

    /* Category tabs (like screenshot) */
    .tabs{
      display:flex;
      gap: 18px;
      align-items:center;
      overflow:auto;
      padding: 10px 2px 0;
      margin-bottom: 14px;
      scrollbar-width: none;
    }
    .tabs::-webkit-scrollbar{ display:none; }

    .tab{
      position: relative;
      color: var(--muted);
      font-weight: 600;
      padding: 10px 0;
      cursor:pointer;
      user-select:none;
      white-space: nowrap;
    }
    .tab .count{
      margin-left: 6px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      height: 18px;
      padding: 0 7px;
      font-size: 12px;
      border-radius: 999px;
      background: #eef0ff;
      color: var(--brand);
      font-weight: 700;
    }
    .tab.active{
      color: var(--brand);
    }
    .tab.active:after{
      content:"";
      position:absolute;
      left:0; right:0; bottom:0;
      height: 3px;
      background: var(--brand);
      border-radius: 999px;
    }

    /* Bulk bar */
    .bulkbar{
      position: sticky;
      top: 10px;
      z-index: 20;
      display:none;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      background:#fff;
      border:1px solid rgba(103,89,255,.25);
      box-shadow: var(--ring), 0 14px 40px rgba(22,24,35,.10);
      border-radius: 14px;
      padding: 10px 12px;
      margin: 10px 0 14px;
    }
    .bulkbar .left{
      display:flex;
      align-items:center;
      gap:10px;
      color: var(--muted);
      font-weight: 600;
    }
    .bulkbar .left strong{ color: var(--text); }
    .bulkbar .actions{
      display:flex;
      align-items:center;
      gap:8px;
    }
    .btn-soft{
      border:1px solid var(--border);
      background:#fff;
    }
    .btn-soft:hover{ border-color: rgba(103,89,255,.35); }

    /* List/table container */
    .panel{
      background: var(--card);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    /* Table list (columns view) */
    .docs-table{
      width:100%;
      border-collapse: separate;
      border-spacing: 0;
    }
    .docs-table thead th{
      font-size: 12px;
      text-transform: none;
      color: var(--muted);
      background: #fbfbfe;
      border-bottom: 1px solid var(--border);
      padding: 12px 14px;
    }
    .docs-table tbody td{
      padding: 12px 14px;
      border-bottom: 1px solid var(--border);
      vertical-align: middle;
    }
    .docs-table tbody tr:hover td{
      background: #fbfbff;
    }

    .doc-row{
      display:flex;
      gap: 12px;
      align-items:center;
      min-width: 360px;
    }
    .thumb{
      width: 46px;
      height: 56px;
      border-radius: 10px;
      background-size: cover;
      background-position:center;
      border:1px solid var(--border);
      flex:0 0 auto;
      box-shadow: 0 10px 20px rgba(22,24,35,.06);
      position: relative;
      overflow:hidden;
    }
    .thumb:after{
      content:"";
      position:absolute;
      inset:0;
      background: linear-gradient(to bottom, rgba(255,255,255,0) 40%, rgba(0,0,0,.05));
      pointer-events:none;
    }
    .doc-title{
      font-weight: 700;
      font-size: 14px;
      line-height: 1.25;
      margin: 0;
    }
    .doc-sub{
      font-size: 12px;
      color: var(--muted);
      margin: 2px 0 0;
    }

    .tag{
      display:inline-flex;
      align-items:center;
      padding: 6px 10px;
      font-weight: 700;
      font-size: 12px;
      border-radius: 999px;
      background: rgba(103,89,255,.10);
      color: var(--brand);
    }

    .avatar{
      width: 28px;
      height: 28px;
      border-radius: 999px;
      background: #eaeaf6;
      display:inline-grid;
      place-items:center;
      font-weight: 800;
      color: #3a3f52;
      border: 1px solid var(--border);
      overflow:hidden;
    }
    .avatar img{
      width:100%;
      height:100%;
      object-fit: cover;
      display:block;
    }

    .rowActions{
      display:flex;
      justify-content:flex-end;
      gap: 8px;
      align-items:center;
      min-width: 120px;
    }
    .miniIcon{
      width: 34px;
      height: 34px;
      border-radius: 10px;
      border:1px solid var(--border);
      background:#fff;
      display:grid;
      place-items:center;
      cursor:pointer;
      transition:.15s ease;
      color:#2b3142;
    }
    .miniIcon:hover{
      border-color: rgba(103,89,255,.35);
      box-shadow: var(--ring);
      color: var(--brand);
      transform: translateY(-1px);
    }

    .k-check{
      width: 18px;
      height: 18px;
      cursor:pointer;
      accent-color: var(--brand);
    }

    /* Grid view (cards like first screenshot) */
    .grid{
      display:grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 16px;
      padding: 16px;
    }
    @media (max-width: 1100px){ .grid{ grid-template-columns: repeat(3, minmax(0, 1fr)); } }
    @media (max-width: 860px){ .grid{ grid-template-columns: repeat(2, minmax(0, 1fr)); } }
    @media (max-width: 520px){ .grid{ grid-template-columns: 1fr; } }

    .cardDoc{
      border:1px solid var(--border);
      border-radius: 16px;
      overflow:hidden;
      background:#fff;
      box-shadow: 0 10px 28px rgba(22,24,35,.07);
      transition:.15s ease;
      position: relative;
    }
    .cardDoc:hover{ transform: translateY(-2px); box-shadow: 0 16px 36px rgba(22,24,35,.10); }
    .cardPreview{
      height: 180px;
      background-size: cover;
      background-position:center;
      position: relative;
    }
    .cardPreview:after{
      content:"";
      position:absolute;
      inset:0;
      background: linear-gradient(to bottom, rgba(0,0,0,.0) 55%, rgba(0,0,0,.08));
    }
    .cardTop{
      position:absolute;
      top: 10px;
      left: 10px;
      right: 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 8px;
      z-index: 2;
    }
    .cardTop .left{
      display:flex; align-items:center; gap: 8px;
    }
    .badgeType{
      background: rgba(255,255,255,.92);
      border:1px solid rgba(0,0,0,.06);
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 800;
      color: #2b3142;
      display:inline-flex;
      gap:6px;
      align-items:center;
    }
    .badgeType i{ color: var(--brand); }
    .cardBody{
      padding: 12px 12px 14px;
    }
    .cardTitle{
      font-weight: 800;
      font-size: 14px;
      margin: 0;
      line-height: 1.2;
    }
    .cardMeta{
      color: var(--muted);
      font-size: 12px;
      margin-top: 4px;
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap: wrap;
    }

    .foot{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding: 12px 16px;
      color: var(--muted);
      font-size: 12px;
    }

    /* Dropdown menu modern */
    .dropdown-menu{
      border-radius: 14px;
      border: 1px solid var(--border);
      box-shadow: 0 18px 50px rgba(22,24,35,.12);
      padding: 8px;
      min-width: 190px;
    }
    .dropdown-item{
      border-radius: 10px;
      padding: 10px 10px;
      font-weight: 600;
      color: #2b3142;
    }
    .dropdown-item:hover{
      background: rgba(103,89,255,.10);
      color: var(--brand);
    }
    .dropdown-item.text-danger:hover{
      background: rgba(220,53,69,.10);
      color: #dc3545 !important;
    }

    /* Preview modal layout */
    .previewShell{
      display:grid;
      grid-template-columns: 340px 1fr;
      gap: 0;
      min-height: 70vh;
    }
    @media (max-width: 992px){
      .previewShell{ grid-template-columns: 1fr; }
      .previewAside{ border-right: none !important; border-bottom: 1px solid var(--border); }
    }
    .previewAside{
      border-right: 1px solid var(--border);
      background: #fbfbfe;
      padding: 14px;
    }
    .asideTitle{
      font-weight: 900;
      font-size: 14px;
      margin: 0 0 8px;
    }
    .asideMuted{
      color: var(--muted);
      font-size: 12px;
      margin: 0 0 10px;
    }
    .fieldLabel{
      font-size: 12px;
      font-weight: 800;
      color: #3a3f52;
      margin-bottom: 6px;
    }
    .previewMain{
      padding: 0;
      background:#fff;
    }
    .previewFrame{
      width: 100%;
      height: 70vh;
      border: none;
      background:#fff;
    }
  </style>
</head>

<body>
  <div class="app">

    <!-- TOP BAR -->
    <div class="topbar">
      <div class="searchbox">
        <i class="bi bi-search"></i>
        <input id="q" class="form-control" placeholder="Search..." />
      </div>

      <div class="viewBtns">
        <button id="btnGrid" class="iconBtn active" type="button" data-bs-toggle="tooltip" data-bs-title="Vista em grelha" onclick="setView('grid')">
          <i class="bi bi-grid"></i>
        </button>
        <button id="btnCols" class="iconBtn" type="button" data-bs-toggle="tooltip" data-bs-title="Vista em lista" onclick="setView('cols')">
          <i class="bi bi-list"></i>
        </button>
      </div>

      <button class="btn btn-brand text-white d-flex align-items-center gap-2 px-3" type="button">
        <i class="bi bi-plus-lg"></i>
        <span>Add Document</span>
      </button>
    </div>

    <!-- FILTERS -->
    <div class="filters">
      <div class="left">
        <select id="sort" class="pillSelect form-select">
          <option value="recent">Más Reciente</option>
          <option value="oldest">Mais Antigo</option>
          <option value="name">Nome A-Z</option>
        </select>
      </div>
      <div class="right" style="flex:1; justify-content:flex-end;">
        <div class="searchbox" style="max-width: 420px;">
          <i class="bi bi-search"></i>
          <input id="q2" class="form-control" placeholder="Buscar..." />
        </div>
        <button class="btn btn-brand text-white d-flex align-items-center gap-2 px-3" type="button">
          <i class="bi bi-plus-lg"></i>
          <span>Añadir documentos</span>
        </button>
      </div>
    </div>

    <!-- TABS -->
    <div class="tabs" id="tabs"></div>

    <!-- BULK BAR -->
    <div class="bulkbar" id="bulkbar">
      <div class="left">
        <i class="bi bi-check2-square" style="color:var(--brand); font-size:18px;"></i>
        <span><strong id="selCount">0</strong> selecionado(s)</span>
        <button class="btn btn-sm btn-soft" type="button" onclick="selectAllFiltered(true)">Selecionar todos</button>
        <button class="btn btn-sm btn-soft" type="button" onclick="selectAllFiltered(false)">Limpar</button>
      </div>
      <div class="actions">
        <button class="btn btn-sm btn-soft" type="button" data-bs-toggle="modal" data-bs-target="#bulkModal">
          <i class="bi bi-archive"></i> Ações
        </button>
        <button class="btn btn-sm btn-soft" type="button" onclick="deleteSelected()">
          <i class="bi bi-trash"></i> Remover
        </button>
      </div>
    </div>

    <!-- CONTENT -->
    <div class="panel" id="panel">
      <!-- GRID VIEW -->
      <div id="gridView" class="grid"></div>

      <!-- COLUMNS (TABLE) VIEW -->
      <div id="colsView" class="d-none">
        <div class="table-responsive">
          <table class="docs-table">
            <thead>
              <tr>
                <th style="width:50px;"><input id="selectAll" class="k-check" type="checkbox" /></th>
                <th>Todos <span class="count" id="totalCount" style="margin-left:8px;">0</span></th>
                <th style="width:140px;">Categoria</th>
                <th style="width:170px;">Última Actualización</th>
                <th style="width:170px;">Creado por</th>
                <th style="width:140px; text-align:right;">Ações</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>

        <div class="foot">
          <div id="footerInfo">Mostrando 1-10 de 10</div>
          <nav aria-label="Paginação">
            <ul class="pagination pagination-sm mb-0">
              <li class="page-item"><a class="page-link" href="#" onclick="return false;">&lsaquo;</a></li>
              <li class="page-item active"><a class="page-link" href="#" onclick="return false;">1</a></li>
              <li class="page-item"><a class="page-link" href="#" onclick="return false;">2</a></li>
              <li class="page-item"><a class="page-link" href="#" onclick="return false;">3</a></li>
              <li class="page-item"><a class="page-link" href="#" onclick="return false;">4</a></li>
              <li class="page-item"><a class="page-link" href="#" onclick="return false;">&rsaquo;</a></li>
            </ul>
          </nav>
        </div>
      </div>
    </div>

  </div>

  <!-- Bulk actions modal -->
  <div class="modal fade" id="bulkModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content" style="border-radius:16px; overflow:hidden;">
        <div class="modal-header">
          <h6 class="modal-title fw-bold">Ações em massa</h6>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p class="text-muted small mb-3">Seleciona uma opção para os documentos atualmente selecionados.</p>
          <button id="zipBtn" class="btn btn-brand text-white w-100 mb-2">
            <i class="bi bi-file-zip"></i> Descarregar ZIP
          </button>
          <button class="btn btn-outline-danger w-100" onclick="deleteSelected()" data-bs-dismiss="modal">
            <i class="bi bi-trash"></i> Remover selecionados
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Preview modal -->
  <div class="modal fade" id="previewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content" style="border-radius:16px; overflow:hidden;">
        <div class="modal-header">
          <div>
            <div class="fw-bold" id="pvTitle">Pré-visualização</div>
            <div class="text-muted small" id="pvMeta">Relatório em HTML</div>
          </div>
          <div class="d-flex align-items-center gap-2">
            <button class="btn btn-sm btn-soft" type="button" onclick="downloadOne()"><i class="bi bi-download"></i> Descarregar</button>
            <button class="btn-close" data-bs-dismiss="modal"></button>
          </div>
        </div>

        <div class="previewShell">
          <aside class="previewAside">
            <div class="asideTitle">Campos do relatório</div>
            <div class="asideMuted">Estes inputs estão ligados ao template do relatório. Ao alterar, o preview atualiza.</div>
            <div id="fields"></div>

            <hr />
            <div class="asideTitle">Personalização (tabelas)</div>
            <div class="asideMuted">Dentro do relatório, as tabelas têm um botão "..." para mudar cores do cabeçalho/colunas/células.</div>
          </aside>

          <main class="previewMain">
            <iframe id="frame" class="previewFrame"></iframe>
          </main>
        </div>

      </div>
    </div>
  </div>

  <!-- JSZip (real zip) -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

  <script>
    // ------- Seed data (10 docs with previews + HTML templates) -------
    const DOCS = [
      {
        id: "doc-1001",
        title: "Reference-Letter.pdf",
        category: "Evidencias",
        tag: "PDF",
        updated: "Ene 23, 2024",
        createdBy: { name: "Wade Warren", avatar: "https://i.pravatar.cc/80?img=12" },
        size: "3 MB",
        pages: 2,
        preview: "https://imgv2-2-f.scribdassets.com/img/document/786731558/original/410078e228/1?v=1",
        template: {
          fields: [
            { key:"client", label:"Cliente", type:"text", value:"Kiosso Logistics" },
            { key:"ref", label:"Referência", type:"text", value:"#REF-2024-001" },
            { key:"date", label:"Data", type:"date", value:"2024-01-23" }
          ],
          html: `
            <div style="font-family:Inter,system-ui; padding:28px; color:#1f2430;">
              <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:16px;">
                <div>
                  <div style="font-size:12px; color:#6b7280; font-weight:700;">REFERÊNCIA</div>
                  <h1 style="margin:6px 0 0; font-size:22px;">Carta de Referência</h1>
                  <div style="margin-top:8px; color:#6b7280; font-size:13px;">
                    Cliente: <strong>{{client}}</strong> · Data: <strong>{{date}}</strong> · Ref: <strong>{{ref}}</strong>
                  </div>
                </div>
                <div style="width:42px; height:42px; border-radius:12px; background:#6759ff1a; display:grid; place-items:center;">
                  <span style="color:#6759ff; font-weight:900;">K</span>
                </div>
              </div>

              <hr style="border:none; border-top:1px solid #e7e9f3; margin:18px 0;" />

              <p style="line-height:1.6; margin:0 0 12px;">
                Declaramos para os devidos efeitos que a empresa <strong>{{client}}</strong> mantém uma relação comercial ativa,
                com desempenho consistente e cumprimento das obrigações acordadas.
              </p>

              <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-top:16px;">
                <div style="border:1px solid #e7e9f3; border-radius:14px; padding:14px;">
                  <div style="font-weight:900; font-size:12px; color:#6b7280;">Resumo</div>
                  <div style="margin-top:6px; font-size:13px;">Entrega e conformidade documental dentro dos prazos.</div>
                </div>
                <div style="border:1px solid #e7e9f3; border-radius:14px; padding:14px;">
                  <div style="font-weight:900; font-size:12px; color:#6b7280;">Contacto</div>
                  <div style="margin-top:6px; font-size:13px;">support@kiosso.com</div>
                </div>
              </div>

              <h3 style="margin:20px 0 10px; font-size:16px;">Histórico</h3>
              <table data-k-table="1" style="width:100%; border-collapse:separate; border-spacing:0; overflow:hidden; border:1px solid #e7e9f3; border-radius:14px;">
                <thead>
                  <tr style="background:#6759ff; color:#fff;">
                    <th style="text-align:left; padding:12px;">Mês</th>
                    <th style="text-align:left; padding:12px;">Ocorrências</th>
                    <th style="text-align:left; padding:12px;">Estado</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td style="padding:12px; border-top:1px solid #e7e9f3;">Janeiro</td>
                    <td style="padding:12px; border-top:1px solid #e7e9f3;">0</td>
                    <td style="padding:12px; border-top:1px solid #e7e9f3;"><strong>Conforme</strong></td>
                  </tr>
                  <tr>
                    <td style="padding:12px; border-top:1px solid #e7e9f3;">Fevereiro</td>
                    <td style="padding:12px; border-top:1px solid #e7e9f3;">1</td>
                    <td style="padding:12px; border-top:1px solid #e7e9f3;"><strong>Resolvido</strong></td>
                  </tr>
                </tbody>
              </table>
            </div>
          `
        }
      },

      {
        id: "doc-1002",
        title: "Self-Declaration.pdf",
        category: "SOP",
        tag: "SOP",
        updated: "Feb 23, 2024",
        createdBy: { name: "Darrell Steward", avatar: "https://i.pravatar.cc/80?img=32" },
        size: "3 MB",
        pages: 3,
        preview: "https://website-assets.studocu.com/img/document_thumbnails/a36cecae2bcd3ef4022de5cb96b3c3f1/thumb_1200_1698.png",
        template: {
          fields: [
            { key:"employee", label:"Colaborador", type:"text", value:"João Pereira" },
            { key:"role", label:"Função", type:"text", value:"Operações" },
            { key:"bank", label:"Banco", type:"select", value:"Millennium", options:["Millennium","CGD","Santander","Novo Banco"] },
          ],
          html: `
            <div style="font-family:Inter,system-ui; padding:26px; color:#1f2430;">
              <h2 style="margin:0 0 4px;">Declaração</h2>
              <div style="color:#6b7280; font-size:13px;">Colaborador: <strong>{{employee}}</strong> · Função: <strong>{{role}}</strong> · Banco: <strong>{{bank}}</strong></div>

              <div style="margin-top:16px; border:1px solid #e7e9f3; border-radius:14px; padding:14px;">
                <div style="font-weight:900; font-size:12px; color:#6b7280;">Texto</div>
                <p style="margin:10px 0 0; line-height:1.6;">
                  Eu, <strong>{{employee}}</strong>, declaro para os devidos efeitos que exerço a função de <strong>{{role}}</strong> na organização,
                  mantendo vínculo ativo e regular.
                </p>
              </div>

              <h3 style="margin:18px 0 10px; font-size:16px;">Tabela de validação</h3>
              <table data-k-table="1" style="width:100%; border-collapse:separate; border-spacing:0; border:1px solid #e7e9f3; border-radius:14px; overflow:hidden;">
                <thead>
                  <tr style="background:#111827; color:#fff;">
                    <th style="text-align:left; padding:12px;">Campo</th>
                    <th style="text-align:left; padding:12px;">Valor</th>
                    <th style="text-align:left; padding:12px;">Estado</th>
                  </tr>
                </thead>
                <tbody>
                  <tr><td style="padding:12px; border-top:1px solid #e7e9f3;">Banco</td><td style="padding:12px; border-top:1px solid #e7e9f3;">{{bank}}</td><td style="padding:12px; border-top:1px solid #e7e9f3;">OK</td></tr>
                  <tr><td style="padding:12px; border-top:1px solid #e7e9f3;">Identidade</td><td style="padding:12px; border-top:1px solid #e7e9f3;">Verificada</td><td style="padding:12px; border-top:1px solid #e7e9f3;">OK</td></tr>
                </tbody>
              </table>
            </div>
          `
        }
      },

      {
        id: "doc-1003",
        title: "Cover-Letter.pdf",
        category: "Carta porte",
        tag: "Carta porte",
        updated: "Mar 23, 2024",
        createdBy: { name: "Brooklyn Simmons", avatar: "https://i.pravatar.cc/80?img=47" },
        size: "3 MB",
        pages: 1,
        preview: "https://www.slideteam.net/wp/wp-content/uploads/2023/03/Planejamento-de-Tarefas-Diarias-para-Relatorio-de-Negocios-2.png",
        template: {
          fields: [
            { key:"company", label:"Empresa", type:"text", value:"Kiosso" },
            { key:"topic", label:"Assunto", type:"text", value:"Apresentação de proposta" },
            { key:"contact", label:"Contacto", type:"text", value:"geral@kiosso.com" },
          ],
          html: `
            <div style="font-family:Inter,system-ui; padding:26px; color:#1f2430;">
              <h1 style="margin:0 0 4px; font-size:22px;">Carta de Apresentação</h1>
              <div style="color:#6b7280; font-size:13px;">Empresa: <strong>{{company}}</strong> · Assunto: <strong>{{topic}}</strong></div>
              <p style="margin-top:14px; line-height:1.65;">
                Esta carta serve para formalizar a comunicação relativa ao tema <strong>{{topic}}</strong>.
                Para qualquer esclarecimento, contactar: <strong>{{contact}}</strong>.
              </p>
              <div style="margin-top:16px; display:flex; gap:10px; align-items:center;">
                <div style="width:10px; height:10px; border-radius:999px; background:#6759ff;"></div>
                <div style="color:#6b7280; font-size:12px;">Documento gerado automaticamente no Centro de Documentos.</div>
              </div>
            </div>
          `
        }
      },

      {
        id: "doc-1004",
        title: "Certificate.pdf",
        category: "Evidencias",
        tag: "Invoice",
        updated: "Abr 23, 2024",
        createdBy: { name: "Jane Cooper", avatar: "https://i.pravatar.cc/80?img=5" },
        size: "3 MB",
        pages: 2,
        preview: "https://www.slideteam.net/wp/wp-content/uploads/2024/03/3-Relatorio-de-status-de-trabalho-diario-do-funcionario-de-uma-pagina.png",
        template: {
          fields: [
            { key:"name", label:"Nome", type:"text", value:"João Silva" },
            { key:"award", label:"Certificação", type:"select", value:"Operações", options:["Operações","Compliance","Qualidade","Logística"] },
            { key:"year", label:"Ano", type:"number", value:"2024" },
          ],
          html: `
            <div style="font-family:Inter,system-ui; padding:28px; color:#1f2430;">
              <div style="border:1px solid #e7e9f3; border-radius:18px; padding:18px;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                  <div style="font-weight:900; letter-spacing:.06em; color:#6b7280; font-size:12px;">CERTIFICATE</div>
                  <div style="width:44px; height:44px; border-radius:14px; background:#6759ff1a; display:grid; place-items:center; color:#6759ff; font-weight:900;">K</div>
                </div>
                <h1 style="margin:14px 0 6px; font-size:26px;">Certificate of Achievement</h1>
                <p style="margin:0; color:#6b7280;">This certificate is proudly presented to</p>
                <h2 style="margin:10px 0 0; font-size:22px;">{{name}}</h2>
                <p style="margin-top:10px; line-height:1.6;">
                  In recognition of outstanding contribution in <strong>{{award}}</strong> during <strong>{{year}}</strong>.
                </p>
              </div>
            </div>
          `
        }
      },

      // extra docs to reach 10
      {
        id: "doc-1005",
        title: "Contrato_Servicio_Transporte_Internacional.pdf",
        category: "Carta porte",
        tag: "Carta porte",
        updated: "Set 23, 2024",
        createdBy: { name: "Wade Warren", avatar: "https://i.pravatar.cc/80?img=12" },
        size: "12 MB",
        pages: 12,
        preview: "https://imgv2-2-f.scribdassets.com/img/document/601542860/original/27bbd5501b/1?v=1",
        template: {
          fields: [
            { key:"shipper", label:"Expedidor", type:"text", value:"Kiosso" },
            { key:"consignee", label:"Consignatário", type:"text", value:"Cliente A" },
            { key:"route", label:"Rota", type:"text", value:"Lisboa → Madrid" },
          ],
          html: `
            <div style="font-family:Inter,system-ui; padding:26px; color:#1f2430;">
              <h2 style="margin:0 0 4px;">Contrato de Transporte</h2>
              <div style="color:#6b7280; font-size:13px;">{{shipper}} · {{consignee}} · {{route}}</div>
              <div style="margin-top:14px; border:1px solid #e7e9f3; border-radius:14px; padding:14px;">
                <div style="font-weight:900; font-size:12px; color:#6b7280;">Cláusulas</div>
                <ol style="margin:10px 0 0; line-height:1.7;">
                  <li>Objeto do contrato e responsabilidades.</li>
                  <li>Prazos, penalidades e condições.</li>
                  <li>Proteção de dados e confidencialidade.</li>
                </ol>
              </div>
            </div>
          `
        }
      },
      {
        id: "doc-1006",
        title: "Guia_Remisión_Transporte_PedidoUrgente.pdf",
        category: "SOP",
        tag: "SOP",
        updated: "Set 23, 2024",
        createdBy: { name: "Darrell Steward", avatar: "https://i.pravatar.cc/80?img=32" },
        size: "5.5 MB",
        pages: 5,
        preview: "https://img.yumpu.com/16768966/1/500x640/relatorio-de-instrucao-de-recursos-administrativos-infraero.jpg",
        template: {
          fields: [
            { key:"code", label:"Código", type:"text", value:"SOP-URG-014" },
            { key:"priority", label:"Prioridade", type:"select", value:"Urgente", options:["Normal","Alta","Urgente"] },
            { key:"owner", label:"Responsável", type:"text", value:"Equipa Operações" },
          ],
          html: `
            <div style="font-family:Inter,system-ui; padding:26px; color:#1f2430;">
              <h2 style="margin:0;">SOP - Guia de Remissão</h2>
              <div style="color:#6b7280; font-size:13px;">Código: <strong>{{code}}</strong> · Prioridade: <strong>{{priority}}</strong> · Responsável: <strong>{{owner}}</strong></div>
              <h3 style="margin:18px 0 10px; font-size:16px;">Checklist</h3>
              <table data-k-table="1" style="width:100%; border-collapse:separate; border-spacing:0; border:1px solid #e7e9f3; border-radius:14px; overflow:hidden;">
                <thead>
                  <tr style="background:#6759ff; color:#fff;">
                    <th style="text-align:left; padding:12px;">Etapa</th>
                    <th style="text-align:left; padding:12px;">Descrição</th>
                    <th style="text-align:left; padding:12px;">Estado</th>
                  </tr>
                </thead>
                <tbody>
                  <tr><td style="padding:12px; border-top:1px solid #e7e9f3;">1</td><td style="padding:12px; border-top:1px solid #e7e9f3;">Validar dados</td><td style="padding:12px; border-top:1px solid #e7e9f3;">Pendente</td></tr>
                  <tr><td style="padding:12px; border-top:1px solid #e7e9f3;">2</td><td style="padding:12px; border-top:1px solid #e7e9f3;">Confirmar rota</td><td style="padding:12px; border-top:1px solid #e7e9f3;">OK</td></tr>
                </tbody>
              </table>
            </div>
          `
        }
      },
      {
        id: "doc-1007",
        title: "Comprovante_Entrega_Final_Proveedor_Local.pdf",
        category: "Evidencias",
        tag: "Invoice",
        updated: "Set 23, 2024",
        createdBy: { name: "Brooklyn Simmons", avatar: "https://i.pravatar.cc/80?img=47" },
        size: "25 MB",
        pages: 10,
        preview: "https://files.passeidireto.com/177a1cde-e3e4-4a58-9dcb-a60e3ce3eee8/177a1cde-e3e4-4a58-9dcb-a60e3ce3eee8.png",
        template: {
          fields: [
            { key:"invoice", label:"Fatura", type:"text", value:"INV-2024-778" },
            { key:"amount", label:"Total", type:"text", value:"1.245,00 €" },
            { key:"status", label:"Estado", type:"select", value:"Pago", options:["Pendente","Pago","Em disputa"] },
          ],
          html: `
            <div style="font-family:Inter,system-ui; padding:26px; color:#1f2430;">
              <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                <div>
                  <div style="font-size:12px; color:#6b7280; font-weight:900;">INVOICE</div>
                  <h2 style="margin:6px 0 0;">{{invoice}}</h2>
                  <div style="color:#6b7280; font-size:13px;">Total: <strong>{{amount}}</strong> · Estado: <strong>{{status}}</strong></div>
                </div>
                <div style="padding:10px 12px; border-radius:999px; background:#6759ff1a; color:#6759ff; font-weight:900;">{{status}}</div>
              </div>
              <h3 style="margin:18px 0 10px; font-size:16px;">Linhas</h3>
              <table data-k-table="1" style="width:100%; border-collapse:separate; border-spacing:0; border:1px solid #e7e9f3; border-radius:14px; overflow:hidden;">
                <thead>
                  <tr style="background:#111827; color:#fff;">
                    <th style="text-align:left; padding:12px;">Item</th>
                    <th style="text-align:right; padding:12px;">Preço</th>
                  </tr>
                </thead>
                <tbody>
                  <tr><td style="padding:12px; border-top:1px solid #e7e9f3;">Serviço A</td><td style="padding:12px; text-align:right; border-top:1px solid #e7e9f3;">800,00 €</td></tr>
                  <tr><td style="padding:12px; border-top:1px solid #e7e9f3;">Serviço B</td><td style="padding:12px; text-align:right; border-top:1px solid #e7e9f3;">445,00 €</td></tr>
                </tbody>
              </table>
            </div>
          `
        }
      },
      {
        id: "doc-1008",
        title: "Solicitud_de_Transporte_Internacional_Cliente_A.pdf",
        category: "SOP",
        tag: "SOP",
        updated: "Ene 23, 2024",
        createdBy: { name: "Jane Cooper", avatar: "https://i.pravatar.cc/80?img=5" },
        size: "100 MB",
        pages: 100,
        preview: "https://files.passeidireto.com/9b8a918f-82fb-460b-970f-c70505fb4dca/9b8a918f-82fb-460b-970f-c70505fb4dca.png",
        template: {
          fields: [
            { key:"client", label:"Cliente", type:"text", value:"Cliente A" },
            { key:"mode", label:"Modal", type:"select", value:"Aéreo", options:["Rodoviário","Marítimo","Aéreo"] },
            { key:"deadline", label:"Prazo", type:"date", value:"2024-01-23" },
          ],
          html: `
            <div style="font-family:Inter,system-ui; padding:26px; color:#1f2430;">
              <h2 style="margin:0;">Solicitação de Transporte</h2>
              <div style="color:#6b7280; font-size:13px;">Cliente: <strong>{{client}}</strong> · Modal: <strong>{{mode}}</strong> · Prazo: <strong>{{deadline}}</strong></div>
              <p style="margin-top:12px; line-height:1.65;">Este documento formaliza o pedido e serve de base para o planeamento operacional.</p>
            </div>
          `
        }
      },
      {
        id: "doc-1009",
        title: "Relatorio_Analitico_Compliance.pdf",
        category: "Evidencias",
        tag: "PDF",
        updated: "Jun 12, 2024",
        createdBy: { name: "Wade Warren", avatar: "https://i.pravatar.cc/80?img=12" },
        size: "8 MB",
        pages: 8,
        preview: "https://imgv2-1-f.scribdassets.com/img/document/380178454/original/8b10ba6006/1?v=1",
        template: {
          fields: [
            { key:"period", label:"Período", type:"text", value:"Q2 2024" },
            { key:"risk", label:"Risco", type:"select", value:"Médio", options:["Baixo","Médio","Alto"] },
            { key:"owner", label:"Responsável", type:"text", value:"Compliance" },
          ],
          html: `
            <div style="font-family:Inter,system-ui; padding:26px; color:#1f2430;">
              <h2 style="margin:0;">Relatório Analítico</h2>
              <div style="color:#6b7280; font-size:13px;">Período: <strong>{{period}}</strong> · Risco: <strong>{{risk}}</strong> · Owner: <strong>{{owner}}</strong></div>
              <div style="margin-top:14px; display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                <div style="border:1px solid #e7e9f3; border-radius:14px; padding:14px;">
                  <div style="font-weight:900; font-size:12px; color:#6b7280;">Resumo</div>
                  <div style="margin-top:8px; font-size:13px; line-height:1.6;">Indicadores e recomendações para mitigação.</div>
                </div>
                <div style="border:1px solid #e7e9f3; border-radius:14px; padding:14px;">
                  <div style="font-weight:900; font-size:12px; color:#6b7280;">Score</div>
                  <div style="margin-top:8px; font-size:13px; line-height:1.6;">Nível de risco: <strong>{{risk}}</strong></div>
                </div>
              </div>
            </div>
          `
        }
      },
      {
        id: "doc-1010",
        title: "Relatorio_Status_Diario_Operacao.pdf",
        category: "Invoice",
        tag: "Invoice",
        updated: "Jul 01, 2024",
        createdBy: { name: "Darrell Steward", avatar: "https://i.pravatar.cc/80?img=32" },
        size: "6 MB",
        pages: 4,
        preview: "https://imgv2-2-f.scribdassets.com/img/document/379493020/original/93ffe6357d/1?v=1",
        template: {
          fields: [
            { key:"day", label:"Dia", type:"date", value:"2024-07-01" },
            { key:"shift", label:"Turno", type:"select", value:"Manhã", options:["Manhã","Tarde","Noite"] },
            { key:"kpi", label:"KPI principal", type:"text", value:"OTIF 96%" },
          ],
          html: `
            <div style="font-family:Inter,system-ui; padding:26px; color:#1f2430;">
              <h2 style="margin:0;">Relatório de Status Diário</h2>
              <div style="color:#6b7280; font-size:13px;">Dia: <strong>{{day}}</strong> · Turno: <strong>{{shift}}</strong> · KPI: <strong>{{kpi}}</strong></div>
              <h3 style="margin:18px 0 10px; font-size:16px;">KPIs</h3>
              <table data-k-table="1" style="width:100%; border-collapse:separate; border-spacing:0; border:1px solid #e7e9f3; border-radius:14px; overflow:hidden;">
                <thead>
                  <tr style="background:#6759ff; color:#fff;">
                    <th style="text-align:left; padding:12px;">Métrica</th>
                    <th style="text-align:left; padding:12px;">Valor</th>
                  </tr>
                </thead>
                <tbody>
                  <tr><td style="padding:12px; border-top:1px solid #e7e9f3;">OTIF</td><td style="padding:12px; border-top:1px solid #e7e9f3;">{{kpi}}</td></tr>
                  <tr><td style="padding:12px; border-top:1px solid #e7e9f3;">Atrasos</td><td style="padding:12px; border-top:1px solid #e7e9f3;">2</td></tr>
                </tbody>
              </table>
            </div>
          `
        }
      },
    ];

    // ------- State -------
    let view = "grid";
    let activeTab = "Todos";
    let selected = new Set();
    let currentPreviewId = null;

    const $tabs = document.getElementById("tabs");
    const $grid = document.getElementById("gridView");
    const $tbody = document.getElementById("tbody");
    const $selectAll = document.getElementById("selectAll");
    const $bulkbar = document.getElementById("bulkbar");
    const $selCount = document.getElementById("selCount");

    // ------- Tabs derived from categories -------
    function buildTabs(){
      const counts = DOCS.reduce((acc,d)=>{
        acc[d.category] = (acc[d.category]||0)+1;
        return acc;
      }, {});
      const items = ["Todos", ...Object.keys(counts)];

      $tabs.innerHTML = items.map(name => `
        <div class="tab ${name===activeTab?'active':''}" onclick="setTab('${name.replace(/'/g,"\\'")}')">
          ${name} <span class="count">${name==="Todos" ? DOCS.length : counts[name]}</span>
        </div>
      `).join("");
    }

    function setTab(name){
      activeTab = name;
      selected.clear();
      syncBulk();
      render();
      buildTabs();
    }

    function setView(v){
      view = v;
      document.getElementById("btnGrid").classList.toggle("active", v==="grid");
      document.getElementById("btnCols").classList.toggle("active", v==="cols");
      document.getElementById("gridView").classList.toggle("d-none", v!=="grid");
      document.getElementById("colsView").classList.toggle("d-none", v!=="cols");
      // reset selectAll checkbox state
      if ($selectAll) $selectAll.checked = false;
    }

    function filteredDocs(){
      const q = (document.getElementById("q").value || "").toLowerCase().trim();
      const q2 = (document.getElementById("q2").value || "").toLowerCase().trim();
      const query = (q || q2).trim();
      let arr = [...DOCS];
      if (activeTab !== "Todos") arr = arr.filter(d => d.category === activeTab);
      if (query) arr = arr.filter(d => (d.title + " " + d.category + " " + d.tag + " " + d.createdBy.name).toLowerCase().includes(query));
      // sort
      const s = document.getElementById("sort").value;
      if (s==="name") arr.sort((a,b)=>a.title.localeCompare(b.title));
      if (s==="oldest") arr.sort((a,b)=>new Date(a.updated) - new Date(b.updated));
      // recent (default): keep as is
      return arr;
    }

    // ------- Render -------
    function render(){
      const docs = filteredDocs();
      document.getElementById("totalCount").textContent = docs.length;

      // footer info (mock)
      document.getElementById("footerInfo").textContent = `Mostrando 1-${Math.min(10,docs.length)} de ${docs.length}`;

      $grid.innerHTML = docs.map(d => gridCard(d)).join("");
      $tbody.innerHTML = docs.map(d => tableRow(d)).join("");

      // tooltips
      [...document.querySelectorAll('[data-bs-toggle="tooltip"]')].forEach(el => new bootstrap.Tooltip(el));

      // selectAll handler (table view)
      $selectAll.checked = docs.length>0 && docs.every(d => selected.has(d.id));
    }

    function gridCard(d){
      const isSel = selected.has(d.id);
      return `
        <div class="cardDoc">
          <div class="cardPreview" style="background-image:url('${d.preview}')">
            <div class="cardTop">
              <div class="left">
                <input class="k-check" type="checkbox" ${isSel?'checked':''} onchange="toggleSelect('${d.id}', this.checked)" />
                <span class="badgeType"><i class="bi bi-file-earmark-text"></i> ${d.tag}</span>
              </div>
              <div class="dropdown">
                <button class="miniIcon" type="button" data-bs-toggle="dropdown" aria-expanded="false" data-bs-title="Ações" data-bs-toggle="tooltip">
                  <i class="bi bi-three-dots"></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                  <li><a class="dropdown-item" href="#" onclick="openPreview('${d.id}'); return false;"><i class="bi bi-eye me-2"></i>Ver Documento</a></li>
                  <li><a class="dropdown-item" href="#" onclick="renameDoc('${d.id}'); return false;"><i class="bi bi-pencil me-2"></i>Cambiar nombre</a></li>
                  <li><a class="dropdown-item" href="#" onclick="downloadDoc('${d.id}'); return false;"><i class="bi bi-download me-2"></i>Descargar</a></li>
                  <li><hr class="dropdown-divider"></li>
                  <li><a class="dropdown-item text-danger" href="#" onclick="deleteDoc('${d.id}'); return false;"><i class="bi bi-trash me-2"></i>Eliminar</a></li>
                </ul>
              </div>
            </div>
          </div>

          <div class="cardBody">
            <p class="cardTitle">${escapeHtml(d.title)}</p>
            <div class="cardMeta">
              <span>${d.size} · ${d.pages} Pages</span>
              <span>·</span>
              <span>${escapeHtml(d.updated)}</span>
            </div>
            <div class="d-flex align-items-center justify-content-between mt-2">
              <div class="d-flex align-items-center gap-2">
                <span class="avatar"><img src="${d.createdBy.avatar}" alt="" /></span>
                <span class="text-muted small">${escapeHtml(d.createdBy.name)}</span>
              </div>
              <button class="btn btn-sm btn-soft" type="button" onclick="openPreview('${d.id}')"><i class="bi bi-box-arrow-up-right"></i></button>
            </div>
          </div>
        </div>
      `;
    }

    function tableRow(d){
      const isSel = selected.has(d.id);
      return `
        <tr>
          <td><input class="k-check" type="checkbox" ${isSel?'checked':''} onchange="toggleSelect('${d.id}', this.checked)" /></td>
          <td>
            <div class="doc-row">
              <div class="thumb" style="background-image:url('${d.preview}');"></div>
              <div>
                <p class="doc-title">${escapeHtml(d.title)}</p>
                <p class="doc-sub">${d.size} · ${d.pages} Pages</p>
              </div>
            </div>
          </td>
          <td><span class="tag">${escapeHtml(d.tag)}</span></td>
          <td class="text-muted">${escapeHtml(d.updated)}</td>
          <td>
            <div class="d-flex align-items-center gap-2">
              <span class="avatar"><img src="${d.createdBy.avatar}" alt="" /></span>
              <span class="text-muted">${escapeHtml(d.createdBy.name)}</span>
            </div>
          </td>
          <td>
            <div class="rowActions">
              <button class="miniIcon" type="button" onclick="downloadDoc('${d.id}')" data-bs-toggle="tooltip" data-bs-title="Descargar archivo">
                <i class="bi bi-download"></i>
              </button>
              <div class="dropdown">
                <button class="miniIcon" type="button" data-bs-toggle="dropdown" aria-expanded="false" data-bs-toggle="tooltip" data-bs-title="Mais opções">
                  <i class="bi bi-three-dots"></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                  <li><a class="dropdown-item" href="#" onclick="openPreview('${d.id}'); return false;"><i class="bi bi-eye me-2"></i>Ver Documento</a></li>
                  <li><a class="dropdown-item" href="#" onclick="renameDoc('${d.id}'); return false;"><i class="bi bi-pencil me-2"></i>Cambiar nombre</a></li>
                  <li><a class="dropdown-item" href="#" onclick="downloadDoc('${d.id}'); return false;"><i class="bi bi-download me-2"></i>Descargar</a></li>
                  <li><hr class="dropdown-divider"></li>
                  <li><a class="dropdown-item text-danger" href="#" onclick="deleteDoc('${d.id}'); return false;"><i class="bi bi-trash me-2"></i>Eliminar</a></li>
                </ul>
              </div>
            </div>
          </td>
        </tr>
      `;
    }

    // ------- Selection -------
    function toggleSelect(id, on){
      if (on) selected.add(id);
      else selected.delete(id);
      syncBulk();
      // sync selectAll checkbox for current filter (table view)
      const docs = filteredDocs();
      $selectAll.checked = docs.length>0 && docs.every(d => selected.has(d.id));
    }

    function selectAllFiltered(on){
      const docs = filteredDocs();
      if (on) docs.forEach(d => selected.add(d.id));
      else docs.forEach(d => selected.delete(d.id));
      syncBulk();
      render();
    }

    function syncBulk(){
      $selCount.textContent = selected.size;
      $bulkbar.style.display = selected.size ? "flex" : "none";
    }

    // SelectAll checkbox (table header)
    $selectAll.addEventListener("change", (e)=>{
      selectAllFiltered(e.target.checked);
    });

    // Search listeners
    ["q","q2"].forEach(id=>{
      document.getElementById(id).addEventListener("input", ()=>{
        selected.clear();
        syncBulk();
        render();
      });
    });
    document.getElementById("sort").addEventListener("change", render);

    // ------- Actions -------
    function deleteDoc(id){
      const idx = DOCS.findIndex(d => d.id===id);
      if (idx>=0){
        if (!confirm("Eliminar este documento?")) return;
        DOCS.splice(idx,1);
        selected.delete(id);
        syncBulk();
        buildTabs();
        render();
      }
    }

    function deleteSelected(){
      if (!selected.size) return;
      if (!confirm(`Eliminar ${selected.size} documento(s)?`)) return;
      for (const id of [...selected]){
        const idx = DOCS.findIndex(d => d.id===id);
        if (idx>=0) DOCS.splice(idx,1);
      }
      selected.clear();
      syncBulk();
      buildTabs();
      render();
    }

    function renameDoc(id){
      const d = DOCS.find(x=>x.id===id);
      const next = prompt("Novo nome:", d.title);
      if (!next) return;
      d.title = next;
      render();
    }

    function downloadDoc(id){
      // mock download (just downloads a small text file representing the document)
      const d = DOCS.find(x=>x.id===id);
      const blob = new Blob([`Documento: ${d.title}\nID: ${d.id}\nCategoria: ${d.category}\n`], {type:"text/plain;charset=utf-8"});
      saveAs(blob, d.title.replace(/\s+/g,"_") + ".txt");
    }

    // ------- Preview modal with dynamic fields + table customization inside iframe -------
    function openPreview(id){
      const d = DOCS.find(x=>x.id===id);
      if (!d) return;
      currentPreviewId = id;

      document.getElementById("pvTitle").textContent = d.title;
      document.getElementById("pvMeta").textContent = `${d.category} · ${d.tag} · ${d.updated}`;

      // build fields form
      const $fields = document.getElementById("fields");
      $fields.innerHTML = d.template.fields.map(f => fieldControl(f)).join("");

      // attach listeners
      d.template.fields.forEach(f=>{
        const el = document.getElementById(`f_${f.key}`);
        if (!el) return;
        el.addEventListener("input", ()=>{
          f.value = el.value;
          updateFrame();
        });
        el.addEventListener("change", ()=>{
          f.value = el.value;
          updateFrame();
        });
      });

      updateFrame();

      new bootstrap.Modal(document.getElementById("previewModal")).show();
    }

    function fieldControl(f){
      if (f.type === "select"){
        return `
          <div class="mb-3">
            <div class="fieldLabel">${escapeHtml(f.label)}</div>
            <select class="form-select" id="f_${f.key}">
              ${(f.options||[]).map(o => `<option ${o===f.value?'selected':''}>${escapeHtml(o)}</option>`).join("")}
            </select>
          </div>
        `;
      }
      return `
        <div class="mb-3">
          <div class="fieldLabel">${escapeHtml(f.label)}</div>
          <input class="form-control" id="f_${f.key}" type="${f.type||'text'}" value="${escapeAttr(f.value ?? '')}">
        </div>
      `;
    }

    function applyTemplate(html, fields){
      let out = html;
      fields.forEach(f=>{
        const val = (f.value ?? "").toString();
        out = out.replaceAll(`{{${f.key}}}`, escapeHtml(val));
      });
      return out;
    }
 

function frameDoc(innerHtml){
  // IMPORTANTE:
  // - Não pode existir o literal "</script>" no HTML principal.
  // - Por isso, montamos as tags <script> e </script> por concatenação.

  const scriptOpen  = "<scr" + "ipt>";
  const scriptClose = "</scr" + "ipt>";

  const toolsCode = `
    (function(){
      const BRAND = '#6759ff';

      const css = \`
        .k-twrap{ position:relative; }
        .k-tbtn{
          position:absolute; top:10px; right:10px;
          width:34px; height:34px; border-radius:10px;
          border:1px solid rgba(0,0,0,.08);
          background: rgba(255,255,255,.96);
          display:grid; place-items:center;
          box-shadow: 0 12px 26px rgba(0,0,0,.12);
          cursor:pointer;
          z-index: 20;
          user-select:none;
        }
        .k-tbtn:hover{ outline: 4px solid rgba(103,89,255,.16); border-color: rgba(103,89,255,.35); }
        .k-panel{
          position:absolute; top:52px; right:10px;
          width: 220px;
          padding: 10px;
          border-radius: 14px;
          background:#fff;
          border: 1px solid rgba(0,0,0,.08);
          box-shadow: 0 20px 60px rgba(0,0,0,.18);
          font-family: Inter, system-ui, Arial;
          z-index: 30;
          display:none;
        }
        .k-panel h4{ margin:0 0 8px; font-size:12px; letter-spacing:.04em; color:#6b7280; }
        .k-row{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin:8px 0; }
        .k-row label{ font-size:12px; font-weight:800; color:#111827; }
        .k-row input[type=color]{ width:44px; height:30px; border:none; background:transparent; padding:0; }
        .k-actions{ display:flex; gap:8px; margin-top:10px; }
        .k-actions button{
          flex:1; height:34px; border-radius:12px; border:1px solid rgba(0,0,0,.10);
          background:#fff; cursor:pointer; font-weight:800;
        }
        .k-actions button.primary{
          background: \${BRAND}; color:#fff; border-color:\${BRAND};
        }
      \`;

      const style = document.createElement('style');
      style.textContent = css;
      document.head.appendChild(style);

      function wrapTable(table){
        if (!table || table.closest('.k-twrap')) return;

        const wrap = document.createElement('div');
        wrap.className = 'k-twrap';
        table.parentNode.insertBefore(wrap, table);
        wrap.appendChild(table);

        const btn = document.createElement('div');
        btn.className = 'k-tbtn';
        btn.innerHTML = '&#8942;';
        wrap.appendChild(btn);

        const panel = document.createElement('div');
        panel.className = 'k-panel';
        panel.innerHTML = \`
          <h4>Personalizar tabela</h4>
          <div class="k-row">
            <label>Header</label>
            <input data-k="thead" type="color" value="#6759ff">
          </div>
          <div class="k-row">
            <label>Coluna 1</label>
            <input data-k="col1" type="color" value="#ffffff">
          </div>
          <div class="k-row">
            <label>Células</label>
            <input data-k="cells" type="color" value="#ffffff">
          </div>
          <div class="k-actions">
            <button class="primary" data-k="apply">Aplicar</button>
            <button data-k="close">Fechar</button>
          </div>
        \`;
        wrap.appendChild(panel);

        btn.addEventListener('click', (e)=>{
          e.stopPropagation();
          panel.style.display = (panel.style.display === 'block') ? 'none' : 'block';
        });

        panel.querySelector('[data-k=close]').addEventListener('click', (e)=>{
          e.stopPropagation();
          panel.style.display = 'none';
        });

        panel.querySelector('[data-k=apply]').addEventListener('click', (e)=>{
          e.stopPropagation();

          const headColor = panel.querySelector('input[data-k=thead]').value;
          const col1 = panel.querySelector('input[data-k=col1]').value;
          const cells = panel.querySelector('input[data-k=cells]').value;

          const theadRow = table.querySelector('thead tr');
          if (theadRow){
            theadRow.style.background = headColor;
            theadRow.style.color = '#fff';
          }

          table.querySelectorAll('tbody tr').forEach(tr=>{
            const td0 = tr.children[0];
            if (td0) td0.style.background = col1;
          });

          table.querySelectorAll('tbody td').forEach(td=>{
            td.style.background = cells;
          });

          panel.style.display = 'none';
        });

        // Fecha quando clicas fora
        document.addEventListener('click', (e)=>{
          if (!wrap.contains(e.target)) panel.style.display = 'none';
        }, true);
      }

      document.querySelectorAll('table[data-k-table]').forEach(wrapTable);
    })();
  `;

  const toolsScript = scriptOpen + toolsCode + scriptClose;

  return `
    <!doctype html>
    <html>
      <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
        <style>
          body{ margin:0; background:#fff; }
          .page{
            max-width: 980px;
            margin: 0 auto;
            padding: 16px;
          }
        </style>
      </head>
      <body>
        <div class="page">${innerHtml}</div>
        ${toolsScript}
      </body>
    </html>
  `;
}


    
    function updateFrame(){
      const d = DOCS.find(x=>x.id===currentPreviewId);
      const html = applyTemplate(d.template.html, d.template.fields);
      document.getElementById("frame").srcdoc = frameDoc(html);
    }

    function downloadOne(){
      if (!currentPreviewId) return;
      downloadDoc(currentPreviewId);
    }

    // ------- ZIP (real) -------
    document.getElementById("zipBtn").addEventListener("click", async ()=>{
      if (!selected.size){
        alert("Nenhum documento selecionado.");
        return;
      }
      const zip = new JSZip();
      for (const id of selected){
        const d = DOCS.find(x=>x.id===id);
        if (!d) continue;
        zip.file(d.title.replace(/[^\w\-\. ]+/g,"").replace(/\s+/g,"_") + ".txt", `Documento: ${d.title}\nID: ${d.id}\nCategoria: ${d.category}\nAtualizado: ${d.updated}\nCriado por: ${d.createdBy.name}\n`);
      }
      const blob = await zip.generateAsync({type:"blob"});
      saveAs(blob, `documentos_${new Date().toISOString().slice(0,10)}.zip`);
    });

    // ------- Helpers -------
    function escapeHtml(str){
      return String(str).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
    }
    function escapeAttr(str){
      return String(str).replace(/"/g,'&quot;');
    }

    // ------- Init -------
    buildTabs();
    render();
    setView("grid");

    // bootstrap tooltips init
    window.addEventListener("load", ()=>{
      [...document.querySelectorAll('[data-bs-toggle="tooltip"]')].forEach(el => new bootstrap.Tooltip(el));
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
